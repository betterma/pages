<!DOCTYPE html>
<html>

<head>
    <title>JSON合并工具（修复版）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #jsonViewer {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            max-height: 500px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: Consolas, monospace;
        }

        .json-item {
            margin: 2px 0;
        }

        .new-item {
            background: #e3f2fd;
            padding: 2px 5px;
            border-left: 3px solid #2196F3;
        }

        .original-item {
            background: #f5f5f5;
            padding: 2px 5px;
        }

        .json-key {
            color: #d32f2f;
        }

        .json-number {
            color: #388e3c;
        }

        .status {
            color: #666;
            margin: 10px 0;
        }

        .loading {
            color: #2196F3;
        }

        .error {
            color: #f44336;
        }
    </style>
</head>

<body>
    <h1>JSON合并工具（修复版）</h1>

    <div class="section">
        <h3>基础数据状态</h3>
        <div id="jsonStatus" class="status loading">正在加载contract.json...</div>
    </div>

    <div class="section">
        <h3>上传新JSON文件</h3>
        <input type="file" id="fileUpload" multiple accept=".json">
        <button onclick="processFiles()">处理并合并文件</button>
        <div id="processStatus" class="status"></div>
    </div>

    <div class="section">
        <h3>合并结果预览</h3>
        <div id="jsonViewer"></div>
    </div>

    <div class="section">
        <button id="downloadBtn" onclick="downloadMerged()" disabled>下载合并后的JSON</button>
    </div>

    <script>
        // 全局数据存储（增强版）
        let dataStore = {
            original: [],      // 初始数据（无_source标记）
            additions: [],     // 新增数据
            allKeys: new Set() // 全局键值索引
        };

        // 1. 初始化加载（严格去重）
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('../contract.json');
                const rawData = await response.json();

                // 深度处理初始数据
                dataStore.original = rawData.map(item => {
                    const [key, value] = Object.entries(item)
                        .find(([k]) => k !== '_source') || [];

                    if (!key) throw new Error("无效数据格式");

                    // 全局去重检查
                    if (dataStore.allKeys.has(key)) {
                        console.warn(`发现重复键已过滤: ${key}`);
                        return null;
                    }

                    dataStore.allKeys.add(key);
                    return { [key]: value };
                }).filter(Boolean);

                updateUI();
            } catch (error) {
                console.error("初始化失败:", error);
            }
        });

        // 2. 文件处理（三重去重）
        async function processFiles() {
            const files = [...document.getElementById('fileUpload').files];
            if (files.length === 0) return;

            let addedCount = 0;
            let duplicateCount = 0;

            // 第一阶段：并行解析文件
            const fileResults = await Promise.all(
                files.map(async file => {
                    try {
                        return await parseFile(file);
                    } catch (error) {
                        console.error(`文件解析失败: ${file.name}`, error);
                        return [];
                    }
                })
            );

            // 第二阶段：全局去重
            fileResults.flat().forEach(([key, value]) => {
                if (!dataStore.allKeys.has(key)) {
                    dataStore.additions.push({ [key]: value });
                    dataStore.allKeys.add(key);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            });

            // 第三阶段：排序新增数据
            dataStore.additions.sort((a, b) => {
                const aVal = Object.values(a)[0];
                const bVal = Object.values(b)[0];
                for (let i = 0; i < aVal.length; i++) {
                    if (aVal[i] !== bVal[i]) return bVal[i] - aVal[i];
                }
                return 0;
            });

            // 更新状态
            document.getElementById('processStatus').innerHTML = `
                新增数据: ${addedCount} 条 | 
                过滤重复: ${duplicateCount} 条 |
                总数据量: ${dataStore.allKeys.size} 条
            `;

            updateUI();
        }

        // 文件解析（带文件内去重）
        async function parseFile(file) {
            const text = await file.text();
            const jsonData = JSON.parse(text);

            if (!Array.isArray(jsonData)) {
                throw new Error("必须为JSON数组");
            }

            // 文件内去重（保留最后出现的值）
            const fileMap = new Map();
            jsonData.forEach(item => {
                const [key, value] = Object.entries(item)
                    .find(([k]) => k !== '_source') || [];

                if (key) fileMap.set(key, value);
            });

            return Array.from(fileMap.entries());
        }
        function updateJsonViewer() {
            const combinedData = [
                ...mergedData.original.map(item => ({ ...item, _source: "original" })),
                ...mergedData.additions.map(item => ({ ...item, _source: "new" }))
            ];

            const jsonHtml = combinedData.map(item => {
                const key = Object.keys(item)[0];
                const values = item[key];
                const sourceClass = item._source === 'new' ? 'new-item' : 'original-item';

                return `
                    <div class="json-item ${sourceClass}">
                        <span class="json-key">"${key}"</span>: [
                        ${values.map(v => `<span class="json-number">${v}</span>`).join(', ')}
                        ],
                        <em style="color:#666">// ${item._source}</em>
                    </div>
                `;
            }).join('');

            document.getElementById('jsonViewer').innerHTML = [
                '[',
                jsonHtml,
                ']'
            ].join('\n');
        }

        function downloadMerged() {
            const finalData = [
                ...mergedData.original.map(item => ({ ...item, _source: "original" })),
                ...mergedData.additions.map(item => ({ ...item, _source: "new" }))
            ];

            const jsonStr = JSON.stringify(finalData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `merged-contract-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>