<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据查看工具</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #4cc9f0;
            --success: #4ade80;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8f9fa;
            --dark: #2b2d42;
            --gray: #6b7280;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            .card {
                padding: 1rem;
            }
            .stats {
                flex-direction: column;
            }
            .stat-box {
                margin-bottom: 1rem;
            }
            .table-container {
                overflow-x: auto;
            }
            table {
                min-width: 600px;
            }
            input, button {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            .filter-row {
                display: flex;
                flex-direction: column;
            }
        }
        
        h1 {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .status {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-weight: 500;
        }
        
        .status.loading {
            background-color: #dbeafe;
            color: var(--primary);
        }
        
        .status.success {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status.warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        #jsonViewer {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            background-color: #f5f5f5;
            padding: 1.5rem;
            border-radius: 6px;
            max-height: 500px;
            overflow: auto;
        }
        
        .json-item {
            margin: 0.5rem 0;
        }
        
        .json-key {
            color: #7e22ce;
            font-weight: bold;
        }
        
        .json-value {
            color: #065f46;
        }

        .table-container {
            max-height: 500px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            font-weight: bold;
        }
        
        .stats {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-box {
            flex: 1;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <h1>数据查看工具</h1>
    
    <div class="card">
        <h2>选择数据文件</h2>
        <label for="baseFileSelect">选择数据文件：</label>
        <select id="baseFileSelect" style="margin-bottom: 1rem;">
            <option value="contract.json">contract.json</option>
            <option value="99.json">99.json</option>
            <option value="85.json">85.json</option>
        </select>
        <button onclick="window.location.href='../mergeNew.html/index.html'" style="margin-left: 1rem;">跳转到合并工具</button>
        <div class="filter-row" style="margin-top: 1rem;">
            <label for="minMarketCap">最小市值：</label>
            <input type="number" id="minMarketCap" value="10000000" style="margin-right: 1rem;">
            <label for="minVolume">最小交易量：</label>
            <input type="number" id="minVolume" placeholder="0" style="margin-right: 1rem;">
            <button id="queryBtn" onclick="queryAndFilter()">查询并过滤</button>
        </div>
        <div id="queryStatus" class="status"></div>
        <div id="jsonStatus" class="status loading" style="display: none;">
            ⏳ 正在加载数据...
        </div>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="dataCount">0</div>
                <div class="stat-label">数据条数</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>数据预览</h2>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>合约</th>
                        <th>市值</th>
                        <th>交易量</th>
                    </tr>
                </thead>
                <tbody id="dataBody">
                    <tr>
                        <td colspan="3">[等待数据加载...]</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 数据存储
        let currentData = [];
        let filteredData = [];

        // 初始化加载数据
        window.addEventListener('DOMContentLoaded', async () => {
            const selectEl = document.getElementById('baseFileSelect');
            selectEl.addEventListener('change', () => {
                loadData(selectEl.value);
            });
            // 默认加载第一个
            loadData(selectEl.value);
        });

        async function loadData(filename) {
            const jsonStatusEl = document.getElementById('jsonStatus');
            try {
                jsonStatusEl.style.display = 'block';
                setStatus('', '', 'jsonStatus');
                // 清空数据
                currentData = [];
                filteredData = [];

                const response = await fetch(`../${filename}?time=` + new Date());
                if (!response.ok) {
                    throw new Error(`HTTP错误 ${response.status}`);
                }
                const rawData = await response.json();
                let arr;
                if (Array.isArray(rawData)) {
                    arr = rawData;
                } else if (Array.isArray(rawData.data)) {
                    arr = rawData.data;
                } else {
                    throw new Error("JSON数据必须是数组或包含data数组属性");
                }
                processData(arr);
                updateUI();
                setStatus('✅ 数据加载完成', 'success', 'jsonStatus');
            } catch (error) {
                console.error("加载失败:", error);
                setStatus(`❌ 加载失败: ${error.message}`, 'error', 'jsonStatus');
            } finally {
                if (jsonStatusEl) {
                    jsonStatusEl.style.display = 'none';
                }
            }
        }

        // 处理数据
        function processData(rawData) {
            currentData = rawData.map(item => {
                const [key, value] = Object.entries(item)
                    .find(([k]) => !k.startsWith('_')) || [];
                
                if (!key) return null;
                
                return { [key]: value };
            }).filter(Boolean);
        }

        // 更新UI显示
        function updateUI() {
            // 更新统计信息
            document.getElementById('dataCount').textContent = currentData.length;
            
            // 更新表格
            const tbody = document.getElementById('dataBody');
            if (filteredData.length > 0) {
                tbody.innerHTML = filteredData.map(item => `
                    <tr>
                        <td><span class="json-key">${item.address}</span></td>
                        <td>${item.marketCap ? item.marketCap.toLocaleString() : 'N/A'}</td>
                        <td>${item.volume ? item.volume.toLocaleString() : 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = currentData.map(item => {
                    const key = Object.keys(item).find(k => !k.startsWith('_'));
                    return `
                        <tr>
                            <td><span class="json-key">${key}</span></td>
                            <td>未查询</td>
                            <td>未查询</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // 设置状态显示
        function setStatus(message, type = '', id = 'queryStatus') {
            const statusEl = document.getElementById(id);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // 查询并过滤
        async function queryAndFilter() {
            const minMarketCap = parseFloat(document.getElementById('minMarketCap').value) || 0;
            const minVolume = parseFloat(document.getElementById('minVolume').value) || 0;
            
            const queryBtn = document.getElementById('queryBtn');
            queryBtn.disabled = true;
            queryBtn.textContent = "查询中...";
            
            const updateProgress = (current, total) => {
                setStatus(`⏳ 查询进度: ${current}/${total}`, 'loading');
            };
            
            try {
                const results = await queryTokens(currentData, minMarketCap, minVolume, updateProgress);
                filteredData = results;
                updateUI();
                setStatus(`✅ 查询完成，过滤出 ${filteredData.length} 个合约`, 'success');
            } catch (error) {
                console.error("查询失败:", error);
                setStatus(`❌ 查询失败: ${error.message}`, 'error');
            } finally {
                queryBtn.disabled = false;
                queryBtn.textContent = "查询并过滤";
            }
        }

        // 查询代币数据
        async function queryTokens(data, minMarketCap, minVolume, updateProgress) {
            const addresses = data.map(item => Object.keys(item).find(k => !k.startsWith('_')));
            const results = [];
            let processed = 0;
            
            // 节流：每秒最多 10 个请求（DexScreener 免费API 限制）
            const batchSize = 10;
            for (let i = 0; i < addresses.length; i += batchSize) {
                const batch = addresses.slice(i, i + batchSize);
                const promises = batch.map(async (address) => {
                    try {
                        const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${address}`);
                        if (!response.ok) throw new Error(`API错误 ${response.status}`);
                        const data = await response.json();
                        if (data.pairs && data.pairs.length > 0) {
                            // 取第一个pair的数据，或找到市值最大的
                            const pair = data.pairs.reduce((max, p) => (p.fdv > max.fdv ? p : max), data.pairs[0]);
                            const marketCap = pair.fdv || 0;
                            const volume = pair.volume24h || 0;
                            if (marketCap >= minMarketCap && volume >= minVolume) {
                                return { address, marketCap, volume };
                            }
                        }
                    } catch (error) {
                        console.warn(`查询 ${address} 失败:`, error);
                    }
                    return null;
                });
                const batchResults = await Promise.all(promises);
                results.push(...batchResults.filter(Boolean));
                processed += batch.length;
                updateProgress(processed, addresses.length);
                // 等待1秒
                if (i + batchSize < addresses.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return results;
        }
    </script>
</body>
</html>
